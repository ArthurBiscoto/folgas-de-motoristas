<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Folgas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h2 { text-align: center; }
        input, button { margin: 10px 0; padding: 10px; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 20px;}
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #1F5029; color: white; }
        tr:nth-child(even) { background-color: #262A2E; color: white;} 
        tr:nth-child(odd) { background-color: #212529; color: white;}
        .total-row { background-color: #bdbdbd !important; font-weight: bold; color: white;}
        .saldo-positivo { color: green; font-weight: bold; }
        .saldo-negativo { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h2>Controle de Folgas dos Motoristas</h2>
    <input type="file" id="fileInput" />
    <button onclick="exportarParaExcel()">Exportar para Excel</button>
    
    <table id="resultTable">
        <thead>
            <tr>
                <th>Motorista</th>
                <th>Mês</th>
                <th>Folgas Tiradas</th>
                <th>Saldo de Folgas</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name;
            const intervalo = extrairIntervalo(fileName);

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);

                processData(jsonData, intervalo);
            };
            reader.readAsArrayBuffer(file);
        });

        function extrairIntervalo(nomeArquivo) {
            const regex = /(\d{2}\.\d{4}) A (\d{2}\.\d{4})/;
            const match = nomeArquivo.match(regex);

            if (match) {
                const [inicio, fim] = match.slice(1);
                return { inicio: formatarData(inicio), fim: formatarData(fim) };
            }

            alert("Formato de nome de arquivo inválido! Use: 'FOLGAS 01.2024 A 03.2025'");
            return null;
        }

        function formatarData(data) {
            const [mes, ano] = data.split('.');
            return new Date(ano, mes - 1, 1);
        }

        function gerarMesesEntre(inicio, fim) {
            let meses = [];
            let dataAtual = new Date(inicio);

            while (dataAtual <= fim) {
                const mesAno = `${String(dataAtual.getMonth() + 1).padStart(2, '0')}/${dataAtual.getFullYear()}`;
                meses.push(mesAno);
                dataAtual.setMonth(dataAtual.getMonth() + 1);
            }

            return meses;
        }

        function processData(data, intervalo) {
            if (!intervalo) return;

            let folgas = {};

            data.forEach(row => {
                if (row["Motivo"] === "Folga" && row["Data"] && row["Motorista"]) {
                    let motorista = row["Motorista"];
                    let [dia, mes, ano] = row["Data"].split("/"); 
                    let mesAno = `${mes}/${ano}`;

                    if (!folgas[motorista]) folgas[motorista] = {};
                    if (!folgas[motorista][mesAno]) folgas[motorista][mesAno] = 0;

                    folgas[motorista][mesAno]++;
                }
            });

            preencherTabela(folgas, intervalo);
        }

        function preencherTabela(folgas, intervalo) {
            let tbody = document.querySelector("#resultTable tbody");
            tbody.innerHTML = "";

            for (let motorista in folgas) {
                let meses = gerarMesesEntre(intervalo.inicio, intervalo.fim);
                let totalFolgas = 0;
                let totalSaldo = 0;

                meses.forEach(mesAno => {
                    let folgasTiradas = folgas[motorista][mesAno] || 0;
                    let saldo = 4 - folgasTiradas; // Cada motorista tem direito a 4 folgas por mês
                    totalFolgas += folgasTiradas;
                    totalSaldo += saldo;

                    let tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${motorista}</td>
                        <td>${mesAno}</td>
                        <td>${folgasTiradas}</td>
                        <td class="${saldo < 0 ? 'saldo-negativo' : 'saldo-positivo'}">${saldo}</td>
                    `;
                    tbody.appendChild(tr);
                });

                let trTotal = document.createElement("tr");
                trTotal.classList.add("total-row");
                trTotal.innerHTML = `
                    <td>${motorista}</td>
                    <td>Total</td>
                    <td>${totalFolgas}</td>
                    <td class="${totalSaldo < 0 ? 'saldo-negativo' : 'saldo-positivo'}">${totalSaldo}</td>
                `;
                tbody.appendChild(trTotal);
            }
        }

        function exportarParaExcel() {
            let table = document.getElementById("resultTable");
            let wb = XLSX.utils.table_to_book(table, { sheet: "Folgas" });
            XLSX.writeFile(wb, "Controle_de_Folgas.xlsx");
        }

        function filtrarTabela() {
            let input = document.getElementById("searchInput").value.toLowerCase();
            let rows = document.querySelectorAll("#resultTable tbody tr");

            rows.forEach(row => {
                let motorista = row.cells[0].innerText.toLowerCase();
                if (motorista.includes(input) || row.cells[1].innerText === "Total") {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }
    </script>

</body>
</html>
